name: è‡ªåŠ¨æ›´æ–°å¹¶ä¿æŒç­¾åˆ°è„šæœ¬æ´»è·ƒ

#è¿™ä¸ªè„šæœ¬ç”¨äºä¿æŒä»“åº“æ´»è·ƒï¼Œé˜²æ­¢actionså› ä¸ºä»“åº“ä¸æ´»è·ƒè‡ªåŠ¨ç¦ç”¨ã€‚ä½ å¯ä»¥ä¸ç”¨ç®¡å®ƒ

on:
  schedule:
    - cron: '0 16 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ 0 ç‚¹è§¦å‘ï¼ˆUTC+8ï¼‰
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹

jobs:
  sync-upstream:
    runs-on: ubuntu-latest

    steps:  
      - name: æ£€å‡ºä»“åº“ä»£ç   
        uses: actions/checkout@v4  
        with:  
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œä¾¿äº rebase/cherry-pick  

      - name: è®¾ç½® Git é…ç½®  
        run: |  
          git config --global user.name "GitHub Actions"  
          git config --global user.email "actions@github.com"  
          git config core.autocrlf false  # é¿å…è¡Œç»“æŸç¬¦è½¬æ¢å¯¼è‡´çš„è™šå‡å˜åŒ–  

      - name: æ·»åŠ ä¸Šæ¸¸ä»“åº“  
        run: |  
          if ! git remote | grep -q upstream; then  
            git remote add upstream https://github.com/zhangMonday/jlc-auto-check-in.git  
          fi  

      - name: åˆ‡æ¢åˆ° main åˆ†æ”¯  
        run: git checkout main  

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°  
        id: check-update  
        run: |  
          git fetch upstream  
          UPDATE_COUNT=$(git rev-list --count main..upstream/main)  
          if [ "$UPDATE_COUNT" -gt 0 ]; then  
            if git diff --quiet -w main..upstream/main; then  
              echo "has_update=false" >> $GITHUB_OUTPUT  
              echo "changes=" >> $GITHUB_OUTPUT  
            else  
              echo "has_update=true" >> $GITHUB_OUTPUT  
              CHANGES=$(git diff --name-only -w main..upstream/main)  
              echo "changes=$CHANGES" >> $GITHUB_OUTPUT  
            fi  
          else  
            echo "has_update=false" >> $GITHUB_OUTPUT  
            echo "changes=" >> $GITHUB_OUTPUT  
          fi  

      - name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°æ˜¯å¦åŒ…å« workflow æ–‡ä»¶  
        if: steps.check-update.outputs.has_update == 'true'  
        id: check-workflow-update  
        run: |  
          if echo "${{ steps.check-update.outputs.changes }}" | grep -q '\.github/workflows/'; then  
            echo "has_workflow_update=true" >> $GITHUB_OUTPUT  
          else  
            echo "has_workflow_update=false" >> $GITHUB_OUTPUT  
          fi  

      - name: æ‹‰å–ä¸Šæ¸¸ä»£ç å¹¶åŒæ­¥ï¼ˆå¦‚æœæœ‰æ›´æ–°ï¼‰  
        if: steps.check-update.outputs.has_update == 'true' && steps.check-workflow-update.outputs.has_workflow_update == 'false'  
        run: |  
          echo "Running: æ‹‰å–ä¸Šæ¸¸ä»£ç å¹¶åŒæ­¥"  
          set -e  
          git fetch upstream  
          # è¿‡æ»¤å‡ºéç©ºæäº¤ï¼ˆå¿½ç•¥åŒ…å«â€œä¿æŒä»“åº“æ´»è·ƒâ€çš„æ¶ˆæ¯ï¼‰  
          NON_EMPTY_COMMITS=$(git rev-list --reverse main..upstream/main --not --grep="ä¿æŒä»“åº“æ´»è·ƒ")  
          EMPTY_COMMITS=$(git rev-list --reverse main..upstream/main --grep="ä¿æŒä»“åº“æ´»è·ƒ")  
          echo "Debug: All upstream commits: $(git rev-list --reverse main..upstream/main)"  
          echo "Debug: Non-empty commits to apply: $NON_EMPTY_COMMITS"  
          echo "Debug: Ignored empty commits: $EMPTY_COMMITS"  
          if [ -n "$NON_EMPTY_COMMITS" ]; then  
            # Cherry-pick éç©ºæäº¤  
            for commit in $NON_EMPTY_COMMITS; do  
              git cherry-pick "$commit" || {  
                git cherry-pick --abort  
                echo "âš ï¸ Cherry-pick å¼‚å¸¸ï¼Œæ‰§è¡Œç©ºæäº¤ä¿æŒæ´»è·ƒ"  
                git commit --allow-empty -m "ä¿æŒä»“åº“æ´»è·ƒï¼ˆæ›´æ–°å¤±è´¥å›é€€ï¼‰"  
                git push origin main  
                exit 1  
              }  
            done  
            git push origin main --force-with-lease  
            echo "âœ… å·²æˆåŠŸ cherry-pick éç©ºæ›´æ–°"  
          else  
            echo "âš ï¸ ä¸Šæ¸¸åªæœ‰ç©ºæäº¤ï¼Œå¿½ç•¥å¹¶ä¿æŒæ´»è·ƒ"  
            git commit --allow-empty -m "ä¿æŒä»“åº“æ´»è·ƒï¼ˆå¿½ç•¥ä¸Šæ¸¸ç©ºæ›´æ–°ï¼‰"  
            git push origin main  
          fi  

      - name: æç¤ºæ‰‹åŠ¨æ›´æ–°ï¼ˆå¦‚æœä¸Šæ¸¸æ›´æ–°åŒ…å« workflow æ–‡ä»¶ï¼‰  
        if: steps.check-update.outputs.has_update == 'true' && steps.check-workflow-update.outputs.has_workflow_update == 'true'  
        run: |  
          echo "Running: æç¤ºæ‰‹åŠ¨æ›´æ–°"  
          echo "âš ï¸ ä¸Šæ¸¸æ›´æ–°åŒ…å« workflow è„šæœ¬å†…å®¹ï¼Œæ— æ³•è‡ªåŠ¨æ›´æ–°ã€‚è¯·åœ¨ä½  fork çš„ä»“åº“ä¸­æ‰¾åˆ° 'Sync fork'æŒ‰é’®ï¼Œæ‰‹åŠ¨ç‚¹å‡»æ›´æ–°ã€‚"  
          git commit --allow-empty -m "ç©ºä¿®æ”¹ï¼Œæ£€æµ‹åˆ°æœ‰æ›´æ–°ï¼Œè¯·æ‰‹åŠ¨æ›´æ–°ä¸€ä¸‹"  
          git push origin main  
          echo "ğŸŸ¢ å·²æäº¤ç©ºä¿®æ”¹ä¿æŒä»“åº“æ´»è·ƒ"  

      - name: æäº¤ç©ºä¿®æ”¹ï¼ˆå¦‚æœæ— æ›´æ–°ï¼‰  
        if: steps.check-update.outputs.has_update == 'false'  
        run: |  
          echo "Running: æäº¤ç©ºä¿®æ”¹ï¼ˆå¦‚æœæ— æ›´æ–°ï¼‰"  
          git commit --allow-empty -m "ç©ºä¿®æ”¹ï¼Œç”¨äºä¿æŒä»“åº“æ´»è·ƒï¼Œé˜²æ­¢è‡ªåŠ¨ç­¾åˆ°å¤±æ•ˆ"  
          git push origin main  
          echo "ğŸŸ¢ æ— æ›´æ–°ï¼Œå·²æäº¤ç©ºä¿®æ”¹ä¿æŒä»“åº“æ´»è·ƒ"  

      - name: Workflow æ€»ç»“  
        run: |  
          echo "Final: has_update = ${{ steps.check-update.outputs.has_update || 'not set' }}"  
          echo "Final: has_workflow_update = ${{ steps.check-workflow-update.outputs.has_workflow_update || 'not set' }}"
