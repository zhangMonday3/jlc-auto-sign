name: è‡ªåŠ¨æ›´æ–°å¹¶ä¿æŒç­¾åˆ°è„šæœ¬æ´»è·ƒ

#è¿™ä¸ªè„šæœ¬ç”¨äºä¿æŒä»“åº“æ´»è·ƒï¼Œé˜²æ­¢actionså› ä¸ºä»“åº“ä¸æ´»è·ƒè‡ªåŠ¨ç¦ç”¨ã€‚ä½ å¯ä»¥ä¸ç”¨ç®¡å®ƒ

on:
  schedule:
    - cron: '0 16 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ 0 ç‚¹è§¦å‘ï¼ˆUTC+8ï¼‰
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹

jobs:
  sync-upstream:
    runs-on: ubuntu-latest

    steps:  
      - name: æ£€å‡ºä»“åº“ä»£ç   
        uses: actions/checkout@v4  
        with:  
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²ï¼Œä¾¿äº rebase  

      - name: è®¾ç½® Git é…ç½®  
        run: |  
          git config --global user.name "GitHub Actions"  
          git config --global user.email "actions@github.com"  
          git config core.autocrlf false  # é¿å…è¡Œç»“æŸç¬¦è½¬æ¢å¯¼è‡´çš„è™šå‡å˜åŒ–  

      - name: æ·»åŠ ä¸Šæ¸¸ä»“åº“  
        run: |  
          if ! git remote | grep -q upstream; then  
            git remote add upstream https://github.com/zhangMonday/jlc-auto-check-in.git  
          fi  

      - name: åˆ‡æ¢åˆ° main åˆ†æ”¯  
        run: git checkout main  

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°  
        id: check-update  
        run: |  
          git fetch upstream  
          UPDATE_COUNT=$(git rev-list --count main..upstream/main)  
          CHANGES=$(git diff --name-only -w main..upstream/main)  
          echo "Debug: Update count = $UPDATE_COUNT"  
          echo "Debug: Changed files (ignoring all whitespace) = '$CHANGES'"  
          if [ "$UPDATE_COUNT" -gt 0 ]; then  
            if git diff --quiet -w main..upstream/main; then  
              echo "Debug: Diff quiet (no substantive changes, ignoring all whitespace), setting has_update=false"  
              echo "has_update=false" >> $GITHUB_OUTPUT  
              echo "changes=" >> $GITHUB_OUTPUT  
            else  
              echo "Debug: Diff not quiet (substantive file changes detected), setting has_update=true"  
              echo "has_update=true" >> $GITHUB_OUTPUT  
              echo "changes=$CHANGES" >> $GITHUB_OUTPUT  
            fi  
          else  
            echo "Debug: No new commits, setting has_update=false"  
            echo "has_update=false" >> $GITHUB_OUTPUT  
            echo "changes=" >> $GITHUB_OUTPUT  
          fi  

      - name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°æ˜¯å¦åŒ…å« workflow æ–‡ä»¶  
        if: steps.check-update.outputs.has_update == 'true'  
        id: check-workflow-update  
        run: |  
          if echo "${{ steps.check-update.outputs.changes }}" | grep -q '\.github/workflows/'; then  
            echo "has_workflow_update=true" >> $GITHUB_OUTPUT  
          else  
            echo "has_workflow_update=false" >> $GITHUB_OUTPUT  
          fi  

      - name: æ‹‰å–ä¸Šæ¸¸ä»£ç å¹¶åŒæ­¥ï¼ˆå¦‚æœæœ‰æ›´æ–°ï¼‰  
        if: steps.check-update.outputs.has_update == 'true' && steps.check-workflow-update.outputs.has_workflow_update == 'false'  
        run: |  
          set -e  
          git fetch upstream  
          if git rebase upstream/main; then  
            git push origin main --force-with-lease  
            echo "âœ… å·²æˆåŠŸæ›´æ–°æœ€æ–°ä»£ç "  
          else  
            git rebase --abort  
            echo "âš ï¸ æ›´æ–°å¼‚å¸¸ï¼Œæ‰§è¡Œç©ºæäº¤ä¿æŒæ´»è·ƒ"  
            git commit --allow-empty -m "ä¿æŒä»“åº“æ´»è·ƒï¼ˆæ›´æ–°å¤±è´¥å›é€€ï¼‰"  
            git push origin main  
          fi  

      - name: æç¤ºæ‰‹åŠ¨æ›´æ–°ï¼ˆå¦‚æœä¸Šæ¸¸æ›´æ–°åŒ…å« workflow æ–‡ä»¶ï¼‰  
        if: steps.check-update.outputs.has_update == 'true' && steps.check-workflow-update.outputs.has_workflow_update == 'true'  
        run: |  
          echo "âš ï¸ ä¸Šæ¸¸æ›´æ–°åŒ…å« workflow è„šæœ¬å†…å®¹ï¼Œæ— æ³•è‡ªåŠ¨æ›´æ–°ã€‚è¯·åœ¨ä½  fork çš„ä»“åº“ä¸­æ‰¾åˆ° 'Sync fork'æŒ‰é’®ï¼Œæ‰‹åŠ¨ç‚¹å‡»æ›´æ–°ã€‚"  
          # ç›´æ¥ç©ºæäº¤ä¿æŒæ´»è·ƒï¼Œæ— éœ€ pullï¼ˆActions å·² checkout æœ€æ–°ï¼‰  
          git commit --allow-empty -m "ç©ºä¿®æ”¹ï¼Œæ£€æµ‹åˆ°æœ‰æ›´æ–°ï¼Œè¯·æ‰‹åŠ¨æ›´æ–°ä¸€ä¸‹"  
          git push origin main  
          echo "ğŸŸ¢ å·²æäº¤ç©ºä¿®æ”¹ä¿æŒä»“åº“æ´»è·ƒ"  

      - name: æäº¤ç©ºä¿®æ”¹ï¼ˆå¦‚æœæ— æ›´æ–°ï¼‰  
        if: steps.check-update.outputs.has_update == 'false'  
        run: |  
          # æ— éœ€ pullï¼ˆActions å·² checkout æœ€æ–°ï¼‰ï¼Œç›´æ¥ç©ºæäº¤  
          git commit --allow-empty -m "ç©ºä¿®æ”¹ï¼Œç”¨äºä¿æŒä»“åº“æ´»è·ƒï¼Œé˜²æ­¢è‡ªåŠ¨ç­¾åˆ°å¤±æ•ˆ"  
          git push origin main  
          echo "ğŸŸ¢ æ— æ›´æ–°ï¼Œå·²æäº¤ç©ºä¿®æ”¹ä¿æŒä»“åº“æ´»è·ƒ"
