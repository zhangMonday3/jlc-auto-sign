name: è‡ªåŠ¨æ›´æ–°å¹¶ä¿æŒç­¾åˆ°è„šæœ¬æ´»è·ƒ

#è¿™ä¸ªè„šæœ¬ç”¨äºä¿æŒä»“åº“æ´»è·ƒï¼Œé˜²æ­¢actionså› ä¸ºä»“åº“ä¸æ´»è·ƒè‡ªåŠ¨ç¦ç”¨ã€‚ä½ å¯ä»¥ä¸ç”¨ç®¡å®ƒ

on:
  schedule:
    - cron: '0 16 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ 0 ç‚¹è§¦å‘ï¼ˆUTC+8ï¼‰
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹

jobs:
  sync-upstream:
    runs-on: ubuntu-latest

    steps:  
      - name: æ£€å‡ºä»“åº“ä»£ç   
        uses: actions/checkout@v4  
        with:  
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œä¾¿äº rebase/cherry-pick  

      - name: è®¾ç½® Git é…ç½®  
        run: |  
          git config --global user.name "GitHub Actions"  
          git config --global user.email "actions@github.com"  
          git config core.autocrlf false  # é¿å…è¡Œç»“æŸç¬¦è½¬æ¢å¯¼è‡´çš„è™šå‡å˜åŒ–  

      - name: æ·»åŠ ä¸Šæ¸¸ä»“åº“  
        run: |  
          if ! git remote | grep -q upstream; then  
            git remote add upstream https://github.com/zhangMonday/jlc-auto-check-in.git  
          fi  

      - name: åˆ‡æ¢åˆ° main åˆ†æ”¯  
        run: git checkout main  

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°  
        id: check-update  
        run: |  
          git fetch upstream  
          UPDATE_COUNT=$(git rev-list --count main..upstream.main)  
          if [ "$UPDATE_COUNT" -gt 0 ]; then  
            if git diff --quiet -w main..upstream.main; then  
              echo "has_update=false" >> $GITHUB_OUTPUT  
              echo "changes<<EOF" >> $GITHUB_OUTPUT  
              echo "" >> $GITHUB_OUTPUT  
              echo "EOF" >> $GITHUB_OUTPUT  
            else  
              echo "has_update=true" >> $GITHUB_OUTPUT  
              CHANGES=$(git diff --name-only -w main..upstream.main)  
              echo "changes<<EOF" >> $GITHUB_OUTPUT  
              echo "$CHANGES" >> $GITHUB_OUTPUT  
              echo "EOF" >> $GITHUB_OUTPUT  
            fi  
          else  
            echo "has_update=false" >> $GITHUB_OUTPUT  
            echo "changes<<EOF" >> $GITHUB_OUTPUT  
            echo "" >> $GITHUB_OUTPUT  
            echo "EOF" >> $GITHUB_OUTPUT  
          fi  

      - name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°æ˜¯å¦åŒ…å« workflow æ–‡ä»¶  
        if: steps.check-update.outputs.has_update == 'true'  
        id: check-workflow-update  
        run: |  
          if echo "${{ steps.check-update.outputs.changes }}" | grep -q '\.github/workflows/'; then  
            echo "has_workflow_update=true" >> $GITHUB_OUTPUT  
          else  
            echo "has_workflow_update=false" >> $GITHUB_OUTPUT  
          fi  

      - name: æ‹‰å–ä¸Šæ¸¸ä»£ç å¹¶åŒæ­¥ï¼ˆå¦‚æœæœ‰æ›´æ–°ï¼‰  
        if: steps.check-update.outputs.has_update == 'true' && steps.check-workflow-update.outputs.has_workflow_update == 'false'  
        run: |  
          echo "æ­£åœ¨æ‰§è¡Œï¼šæ‹‰å–ä¸Šæ¸¸ä»£ç å¹¶åŒæ­¥"  
          set -e  
          git fetch upstream  
          # è¯†åˆ«æ‰€æœ‰ä¸Šæ¸¸æ–°æ›´æ–°
          ALL_COMMITS=($(git rev-list --reverse main..upstream.main))  
          echo "æ‰€æœ‰ä¸Šæ¸¸æ›´æ–°: ${ALL_COMMITS[*]}"  
          # è¿‡æ»¤éç©ºæ›´æ–°ï¼ˆæ¶ˆæ¯ä¸å«"ä¿æŒä»“åº“æ´»è·ƒ"ï¼‰  
          NON_EMPTY_COMMITS=()  
          IGNORED_COMMITS=()  
          for commit in "${ALL_COMMITS[@]}"; do  
            msg=$(git log -1 --format=%s $commit)  
            if echo "$msg" | grep -q "ä¿æŒä»“åº“æ´»è·ƒ\|ç©ºä¿®æ”¹ï¼Œç”¨äºä¿æŒä»“åº“æ´»è·ƒ"; then  
              IGNORED_COMMITS+=("$commit")  
            else  
              NON_EMPTY_COMMITS+=("$commit")  
            fi  
          done  
          echo "è¦åº”ç”¨çš„æ›´æ–°: ${NON_EMPTY_COMMITS[*]}"  
          echo "å¿½ç•¥çš„ç©ºæ›´æ–°: ${IGNORED_COMMITS[*]}"  
          # ä¿å­˜å½“å‰æ ‘ hash  
          OLD_TREE=$(git rev-parse HEAD)  
          if [ ${#NON_EMPTY_COMMITS[@]} -gt 0 ]; then  
            for commit in "${NON_EMPTY_COMMITS[@]}"; do  
              if git cherry-pick --no-commit $commit; then  
                if git diff --quiet --cached; then  
                  git reset  
                  echo "è·³è¿‡å†—ä½™/ç©ºæ›´æ–° $commit"  
                else  
                  git commit -m " $(git log -1 --format=%s $commit) [$commit]"  
                  echo "âœ… å·²åº”ç”¨æ›´æ–° $commit"  
                fi  
              else  
                echo "âš ï¸ æŒ‘é€‰ $commit å¤±è´¥ï¼ˆå¯èƒ½å†²çªï¼‰ï¼Œæ­£åœ¨ä¸­æ­¢"  
                git cherry-pick --abort  
                # ç»§ç»­ä¸‹ä¸€ä¸ªï¼Œä¸åœæ­¢æ•´ä¸ª sync  
              fi  
            done  
          fi  
          # å¦‚æœæ— å®é™…å˜åŒ–åº”ç”¨ï¼Œæ·»åŠ ç©ºæäº¤ä¿æŒæ´»è·ƒ  
          if [ "$OLD_TREE" = "$(git rev-parse HEAD)" ]; then  
            git commit --allow-empty -m "ç©ºä¿®æ”¹ï¼Œç”¨äºä¿æŒä»“åº“æ´»è·ƒï¼Œé˜²æ­¢è‡ªåŠ¨ç­¾åˆ°å¤±æ•ˆ"  
            echo "ğŸŸ¡ æ— æ›´æ–°ï¼Œæ·»åŠ ç©ºæäº¤ä¿æŒæ´»è·ƒ"  
          fi  
          git push origin main --force-with-lease  
          echo "âœ… å·²æˆåŠŸåŒæ­¥ï¼ˆåº”ç”¨äº† ${#NON_EMPTY_COMMITS[@]} ä¸ªæ›´æ–°ï¼‰"  

      - name: æç¤ºæ‰‹åŠ¨æ›´æ–°ï¼ˆå¦‚æœä¸Šæ¸¸æ›´æ–°åŒ…å« workflow æ–‡ä»¶ï¼‰  
        if: steps.check-update.outputs.has_update == 'true' && steps.check-workflow-update.outputs.has_workflow_update == 'true'  
        run: |  
          echo "æ­£åœ¨æ‰§è¡Œï¼šæç¤ºæ‰‹åŠ¨æ›´æ–°"  
          echo "âš ï¸ ä¸Šæ¸¸æ›´æ–°åŒ…å« workflow è„šæœ¬å†…å®¹ï¼Œæ— æ³•è‡ªåŠ¨æ›´æ–°ã€‚è¯·åœ¨ä½  fork çš„ä»“åº“ä¸­æ‰¾åˆ° 'Sync fork'æŒ‰é’®ï¼Œæ‰‹åŠ¨ç‚¹å‡»æ›´æ–°ã€‚"  
          git commit --allow-empty -m "ç©ºä¿®æ”¹ï¼Œç”¨äºä¿æŒä»“åº“æ´»è·ƒï¼Œæ£€æµ‹åˆ°æœ‰æ›´æ–°ï¼Œè¯·æ‰‹åŠ¨æ›´æ–°ä¸€ä¸‹"  
          git push origin main  
          echo "ğŸŸ¢ å·²æäº¤ç©ºä¿®æ”¹ä¿æŒä»“åº“æ´»è·ƒ"  

      - name: æäº¤ç©ºä¿®æ”¹ï¼ˆå¦‚æœæ— æ›´æ–°ï¼‰  
        if: steps.check-update.outputs.has_update == 'false'  
        run: |  
          echo "æ­£åœ¨æ‰§è¡Œï¼šæäº¤ç©ºä¿®æ”¹ï¼ˆå¦‚æœæ— æ›´æ–°ï¼‰"  
          git commit --allow-empty -m "ç©ºä¿®æ”¹ï¼Œç”¨äºä¿æŒä»“åº“æ´»è·ƒï¼Œé˜²æ­¢è‡ªåŠ¨ç­¾åˆ°å¤±æ•ˆ"  
          git push origin main  
          echo "ğŸŸ¢ æ— æ›´æ–°ï¼Œå·²æäº¤ç©ºä¿®æ”¹ä¿æŒä»“åº“æ´»è·ƒ"  

      - name: Workflow æ€»ç»“  
        run: |  
          echo "æœ€ç»ˆç»“æœï¼šhas_update = ${{ steps.check-update.outputs.has_update || 'æœªè®¾ç½®' }}"  
          echo "æœ€ç»ˆç»“æœï¼šhas_workflow_update = ${{ steps.check-workflow-update.outputs.has_workflow_update || 'æœªè®¾ç½®' }}"
